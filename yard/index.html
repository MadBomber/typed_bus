<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'>
<h1 id="label-TypedBus">TypedBus</h1>

<p>Async pub/sub message bus with typed channels, ACK-based delivery, and dead letter queues.</p>

<p>Built on the <a href="https://github.com/socketry/async">async</a> gem with fiber-only concurrency. No mutexes, no threads.</p>

<h2 id="label-Installation">Installation</h2>

<p>Add to your Gemfile:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>typed_bus</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>Then run:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_bundle'>bundle</span> <span class='id identifier rubyid_install'>install</span>
</code></pre>

<h2 id="label-Quick+Start">Quick Start</h2>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>typed_bus</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bus'>bus</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TypedBus/MessageBus.html" title="TypedBus::MessageBus (class)">MessageBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TypedBus/MessageBus.html#initialize-instance_method" title="TypedBus::MessageBus#initialize (method)">new</a></span></span>
<span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_add_channel'>add_channel</span><span class='lparen'>(</span><span class='symbol'>:events</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='int'>5</span><span class='rparen'>)</span>

<span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_subscribe'>subscribe</span><span class='lparen'>(</span><span class='symbol'>:events</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_delivery'>delivery</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>
  <span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_ack!'>ack!</span>
<span class='kw'>end</span>

<span class='const'>Async</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='symbol'>:events</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello world</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span>
</code></pre>

<h2 id="label-Channels">Channels</h2>

<p>A channel is a named pub/sub topic. Subscribers receive <code>Delivery</code> envelopes and must call <code>ack!</code> or <code>nack!</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_channel'>channel</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TypedBus/Channel.html" title="TypedBus::Channel (class)">Channel</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TypedBus/Channel.html#initialize-instance_method" title="TypedBus::Channel#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='symbol'>:orders</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='int'>10</span><span class='rparen'>)</span>
</code></pre>

<h3 id="label-Options">Options</h3>

<table role="table">
<thead>
<tr>
<th>Option</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>‘type`</td>
<td>‘Class`</td>
<td>‘nil`</td>
<td>Restricts published messages to a specific class</td>
</tr>
<tr>
<td>‘timeout`</td>
<td>‘Numeric`</td>
<td>‘30`</td>
<td>Seconds before unresolved deliveries auto-nack</td>
</tr>
<tr>
<td>‘max_pending`</td>
<td>‘Integer`</td>
<td>‘nil`</td>
<td>Backpressure limit; ‘nil` = unbounded</td>
</tr>
<tr>
<td>‘throttle`</td>
<td>‘Float`</td>
<td>‘0.0`</td>
<td>Remaining-capacity ratio where backoff begins; ‘0.0` = disabled</td>
</tr>
</tbody>
</table>

<h3 id="label-Typed+Channels">Typed Channels</h3>

<p>Restrict a channel to a single message class:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_channel'>channel</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TypedBus/Channel.html" title="TypedBus::Channel (class)">Channel</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TypedBus/Channel.html#initialize-instance_method" title="TypedBus::Channel#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='symbol'>:orders</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Order</span><span class='rparen'>)</span>

<span class='const'>Async</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='const'>Order</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='rparen'>)</span>   <span class='comment'># OK
</span>  <span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>not valid</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='comment'># raises ArgumentError
</span><span class='kw'>end</span>
</code></pre>

<h3 id="label-Subscribe+and+Unsubscribe">Subscribe and Unsubscribe</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_id'>id</span> <span class='op'>=</span> <span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_subscribe'>subscribe</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_delivery'>delivery</span><span class='op'>|</span>
  <span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_ack!'>ack!</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_unsubscribe'>unsubscribe</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
</code></pre>

<h3 id="label-Publish">Publish</h3>

<pre class="code ruby"><code class="ruby"><span class='const'>Async</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_tracker'>tracker</span> <span class='op'>=</span> <span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='id identifier rubyid_my_message'>my_message</span><span class='rparen'>)</span>
  <span class='comment'># tracker is a DeliveryTracker (nil if no subscribers)
</span><span class='kw'>end</span>
</code></pre>

<h2 id="label-Delivery">Delivery</h2>

<p>Each subscriber receives a <code>Delivery</code> envelope wrapping the published message. The subscriber must resolve it:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_subscribe'>subscribe</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_delivery'>delivery</span><span class='op'>|</span>
  <span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>    <span class='comment'># the published object
</span>  <span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_channel_name'>channel_name</span>
  <span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_subscriber_id'>subscriber_id</span>

  <span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_ack!'>ack!</span>       <span class='comment'># mark as successfully processed
</span>  <span class='comment'># or
</span>  <span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_nack!'>nack!</span>      <span class='comment'># mark as failed (routes to dead letter queue)
</span><span class='kw'>end</span>
</code></pre>

<p>If neither <code>ack!</code> nor <code>nack!</code> is called before the channel’s <code>timeout</code>, the delivery auto-nacks.</p>

<h3 id="label-Delivery+States">Delivery States</h3>

<table role="table">
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>‘pending?`</td>
<td>Not yet resolved</td>
</tr>
<tr>
<td>‘acked?`</td>
<td>Successfully acknowledged</td>
</tr>
<tr>
<td>‘nacked?`</td>
<td>Explicitly rejected or timed out</td>
</tr>
<tr>
<td>‘timed_out?`</td>
<td>True if the nack was caused by timeout</td>
</tr>
</tbody>
</table>

<h2 id="label-Dead+Letter+Queue">Dead Letter Queue</h2>

<p>Every channel has a dead letter queue that collects failed deliveries (nacked or timed out).</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_dead_letter_queue'>dead_letter_queue</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>
<span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_dead_letter_queue'>dead_letter_queue</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

<span class='comment'># Iterate without removing
</span><span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_dead_letter_queue'>dead_letter_queue</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_delivery'>delivery</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> failed on subscriber #</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_subscriber_id'>subscriber_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='comment'># Drain and reprocess
</span><span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_dead_letter_queue'>dead_letter_queue</span><span class='period'>.</span><span class='id identifier rubyid_drain'>drain</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_delivery'>delivery</span><span class='op'>|</span>
  <span class='id identifier rubyid_retry_message'>retry_message</span><span class='lparen'>(</span><span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>
<span class='kw'>end</span>
</code></pre>

<p>Messages published with no subscribers are also routed to the DLQ.</p>

<h3 id="label-DLQ+Callback">DLQ Callback</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_dead_letter_queue'>dead_letter_queue</span><span class='period'>.</span><span class='id identifier rubyid_on_dead_letter'>on_dead_letter</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_delivery'>delivery</span><span class='op'>|</span>
  <span class='id identifier rubyid_alert'>alert</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Dead letter: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_delivery'>delivery</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span>
</code></pre>

<h2 id="label-Backpressure">Backpressure</h2>

<p>Set <code>max_pending</code> to bound how many unresolved deliveries a channel allows. When the limit is reached, <code>publish</code> blocks the calling fiber until subscribers ack.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_channel'>channel</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TypedBus/Channel.html" title="TypedBus::Channel (class)">Channel</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TypedBus/Channel.html#initialize-instance_method" title="TypedBus::Channel#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='symbol'>:work</span><span class='comma'>,</span>
  <span class='label'>max_pending:</span> <span class='int'>100</span><span class='comma'>,</span>
  <span class='label'>timeout:</span> <span class='int'>10</span>
<span class='rparen'>)</span>
</code></pre>

<h2 id="label-Adaptive+Throttling">Adaptive Throttling</h2>

<p>When a bounded channel approaches capacity, adaptive throttling progressively slows publishers before they hit the hard block.</p>

<p>Set <code>throttle</code> to a <code>Float</code> between <code>0.0</code> (exclusive) and <code>1.0</code> (exclusive). The value is the remaining-capacity ratio at which backoff begins. Below that threshold, each publish sleeps for <code>1 / (max_pending * remaining_ratio)</code> seconds.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_channel'>channel</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TypedBus/Channel.html" title="TypedBus::Channel (class)">Channel</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TypedBus/Channel.html#initialize-instance_method" title="TypedBus::Channel#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='symbol'>:pipeline</span><span class='comma'>,</span>
  <span class='label'>max_pending:</span> <span class='int'>10</span><span class='comma'>,</span>
  <span class='label'>throttle:</span> <span class='float'>0.5</span>   <span class='comment'># begin backoff at 50% remaining capacity
</span><span class='rparen'>)</span>
</code></pre>

<h3 id="label-Backoff+Curve">Backoff Curve</h3>

<p>With <code>max_pending: 10, throttle: 0.5</code>:</p>

<pre class="code ruby"><code class="ruby">Publish  Pending  Remaining  Ratio  Delay
───────────────────────────────────────────
  1        0        10       1.0    —
  2        1         9       0.9    —
  3        2         8       0.8    —
  4        3         7       0.7    —
  5        4         6       0.6    —
  6        5         5       0.5    0.200s
  7        6         4       0.4    0.250s
  8        7         3       0.3    0.333s
  9        8         2       0.2    0.500s
 10        9         1       0.1    1.000s
 11       10         0       0.0    hard block
</code></pre>

<p>The first 50% of capacity fills at full speed. The last 50% applies an asymptotic delay that approaches infinity as remaining capacity approaches zero. At zero remaining, the existing <code>wait_for_capacity</code> hard-blocks until a subscriber acks.</p>

<p>Higher <code>throttle</code> values begin backoff earlier:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TypedBus/Channel.html" title="TypedBus::Channel (class)">Channel</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TypedBus/Channel.html#initialize-instance_method" title="TypedBus::Channel#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='symbol'>:conservative</span><span class='comma'>,</span> <span class='label'>max_pending:</span> <span class='int'>100</span><span class='comma'>,</span> <span class='label'>throttle:</span> <span class='float'>0.8</span><span class='rparen'>)</span>  <span class='comment'># backoff at 80% remaining
</span><span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TypedBus/Channel.html" title="TypedBus::Channel (class)">Channel</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TypedBus/Channel.html#initialize-instance_method" title="TypedBus::Channel#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='symbol'>:aggressive</span><span class='comma'>,</span>   <span class='label'>max_pending:</span> <span class='int'>100</span><span class='comma'>,</span> <span class='label'>throttle:</span> <span class='float'>0.3</span><span class='rparen'>)</span>  <span class='comment'># backoff at 30% remaining
</span></code></pre>

<h2 id="label-Configuration">Configuration</h2>

<p>TypedBus resolves parameters through a three-tier cascade: <strong>Global → Bus → Channel</strong>. Each tier inherits from the one above unless explicitly overridden.</p>

<table role="table">
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>‘timeout`</td>
<td>‘30`</td>
<td>Delivery ACK deadline in seconds</td>
</tr>
<tr>
<td>‘max_pending`</td>
<td>‘nil`</td>
<td>Backpressure limit; ‘nil` = unbounded</td>
</tr>
<tr>
<td>‘throttle`</td>
<td>‘0.0`</td>
<td>Remaining-capacity ratio where backoff begins; ‘0.0` = disabled</td>
</tr>
<tr>
<td>‘logger`</td>
<td>‘nil`</td>
<td>Ruby Logger instance (global-only)</td>
</tr>
<tr>
<td>‘log_level`</td>
<td>‘Logger::INFO`</td>
<td>Log level applied to the logger (global-only)</td>
</tr>
</tbody>
</table>

<h3 id="label-Global+Defaults">Global Defaults</h3>

<pre class="code ruby"><code class="ruby"><span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure'><span class='object_link'><a href="TypedBus.html#configure-class_method" title="TypedBus.configure (method)">configure</a></span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_timeout'>timeout</span>     <span class='op'>=</span> <span class='int'>60</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_max_pending'>max_pending</span> <span class='op'>=</span> <span class='int'>500</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_throttle'>throttle</span>    <span class='op'>=</span> <span class='float'>0.5</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span>      <span class='op'>=</span> <span class='const'>Logger</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='gvar'>$stdout</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_log_level'>log_level</span>   <span class='op'>=</span> <span class='const'>Logger</span><span class='op'>::</span><span class='const'>DEBUG</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="label-Cascade+Example">Cascade Example</h3>

<pre class="code ruby"><code class="ruby"><span class='comment'># Global: timeout=60, max_pending=500
</span><span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure'><span class='object_link'><a href="TypedBus.html#configure-class_method" title="TypedBus.configure (method)">configure</a></span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_timeout'>timeout</span>     <span class='op'>=</span> <span class='int'>60</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_max_pending'>max_pending</span> <span class='op'>=</span> <span class='int'>500</span>
<span class='kw'>end</span>

<span class='comment'># Bus overrides timeout, inherits max_pending
</span><span class='id identifier rubyid_bus'>bus</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TypedBus/MessageBus.html" title="TypedBus::MessageBus (class)">MessageBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TypedBus/MessageBus.html#initialize-instance_method" title="TypedBus::MessageBus#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>timeout:</span> <span class='int'>30</span><span class='rparen'>)</span>

<span class='comment'># Channel inherits both from bus (timeout=30, max_pending=500)
</span><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_add_channel'>add_channel</span><span class='lparen'>(</span><span class='symbol'>:orders</span><span class='rparen'>)</span>

<span class='comment'># Channel overrides timeout, inherits max_pending from bus
</span><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_add_channel'>add_channel</span><span class='lparen'>(</span><span class='symbol'>:alerts</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='int'>5</span><span class='rparen'>)</span>
</code></pre>

<h3 id="label-Reset">Reset</h3>

<p>Restore factory defaults (useful in tests):</p>

<pre class="code ruby"><code class="ruby"><span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_reset_configuration!'><span class='object_link'><a href="TypedBus.html#reset_configuration!-class_method" title="TypedBus.reset_configuration! (method)">reset_configuration!</a></span></span>
</code></pre>

<h2 id="label-MessageBus">MessageBus</h2>

<p><code>MessageBus</code> is a registry facade that manages multiple named channels with shared stats.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_bus'>bus</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TypedBus/MessageBus.html" title="TypedBus::MessageBus (class)">MessageBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TypedBus/MessageBus.html#initialize-instance_method" title="TypedBus::MessageBus#initialize (method)">new</a></span></span>
<span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_add_channel'>add_channel</span><span class='lparen'>(</span><span class='symbol'>:orders</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Order</span><span class='comma'>,</span> <span class='label'>max_pending:</span> <span class='int'>100</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='int'>10</span><span class='rparen'>)</span>
<span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_add_channel'>add_channel</span><span class='lparen'>(</span><span class='symbol'>:alerts</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>String</span><span class='rparen'>)</span>

<span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_subscribe'>subscribe</span><span class='lparen'>(</span><span class='symbol'>:orders</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span> <span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span><span class='semicolon'>;</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_ack!'>ack!</span> <span class='rbrace'>}</span>
<span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_subscribe'>subscribe</span><span class='lparen'>(</span><span class='symbol'>:alerts</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span> <span class='id identifier rubyid_log'>log</span><span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span><span class='semicolon'>;</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_ack!'>ack!</span> <span class='rbrace'>}</span>

<span class='const'>Async</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='symbol'>:orders</span><span class='comma'>,</span> <span class='const'>Order</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='symbol'>:alerts</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>system ok</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="label-Bus-Level+Defaults">Bus-Level Defaults</h3>

<p>Pass <code>timeout</code>, <code>max_pending</code>, or <code>throttle</code> to the constructor to set defaults for all channels on this bus:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_bus'>bus</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TypedBus/MessageBus.html" title="TypedBus::MessageBus (class)">MessageBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TypedBus/MessageBus.html#initialize-instance_method" title="TypedBus::MessageBus#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>timeout:</span> <span class='int'>10</span><span class='comma'>,</span> <span class='label'>max_pending:</span> <span class='int'>200</span><span class='comma'>,</span> <span class='label'>throttle:</span> <span class='float'>0.5</span><span class='rparen'>)</span>

<span class='comment'># Inherits all bus defaults
</span><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_add_channel'>add_channel</span><span class='lparen'>(</span><span class='symbol'>:orders</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='const'>Order</span><span class='rparen'>)</span>

<span class='comment'># Overrides throttle, inherits timeout and max_pending
</span><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_add_channel'>add_channel</span><span class='lparen'>(</span><span class='symbol'>:alerts</span><span class='comma'>,</span> <span class='label'>throttle:</span> <span class='float'>0.3</span><span class='rparen'>)</span>

<span class='comment'># Disables throttle for this channel
</span><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_add_channel'>add_channel</span><span class='lparen'>(</span><span class='symbol'>:logs</span><span class='comma'>,</span> <span class='label'>throttle:</span> <span class='float'>0.0</span><span class='rparen'>)</span>
</code></pre>

<h3 id="label-Bus+Methods">Bus Methods</h3>

<table role="table">
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>‘add_channel(name, **opts)`</td>
<td>Register a named channel</td>
</tr>
<tr>
<td>‘remove_channel(name)`</td>
<td>Close and remove a channel</td>
</tr>
<tr>
<td>‘publish(name, message)`</td>
<td>Publish to a named channel</td>
</tr>
<tr>
<td>‘subscribe(name, &amp;block)`</td>
<td>Subscribe to a named channel</td>
</tr>
<tr>
<td>‘unsubscribe(name, id)`</td>
<td>Remove a subscriber</td>
</tr>
<tr>
<td>‘pending?(name)`</td>
<td>Check for unresolved deliveries</td>
</tr>
<tr>
<td>‘pending_count(name)`</td>
<td>Count unresolved deliveries</td>
</tr>
<tr>
<td>‘dead_letters(name)`</td>
<td>Access a channel’s DLQ</td>
</tr>
<tr>
<td>‘close(name)`</td>
<td>Close a specific channel</td>
</tr>
<tr>
<td>‘close_all`</td>
<td>Close all channels</td>
</tr>
<tr>
<td>‘channel?(name)`</td>
<td>Check if a channel exists</td>
</tr>
<tr>
<td>‘channel_names`</td>
<td>List registered channel names</td>
</tr>
<tr>
<td>‘clear!`</td>
<td>Reset all channels and stats</td>
</tr>
<tr>
<td>‘stats`</td>
<td>Access the shared Stats object</td>
</tr>
</tbody>
</table>

<h2 id="label-Stats">Stats</h2>

<p><code>MessageBus</code> tracks per-channel counters automatically:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_stats'>stats</span><span class='lbracket'>[</span><span class='symbol'>:orders_published</span><span class='rbracket'>]</span>     <span class='comment'># messages published
</span><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_stats'>stats</span><span class='lbracket'>[</span><span class='symbol'>:orders_delivered</span><span class='rbracket'>]</span>     <span class='comment'># all subscribers acked
</span><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_stats'>stats</span><span class='lbracket'>[</span><span class='symbol'>:orders_nacked</span><span class='rbracket'>]</span>        <span class='comment'># explicit nacks
</span><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_stats'>stats</span><span class='lbracket'>[</span><span class='symbol'>:orders_timed_out</span><span class='rbracket'>]</span>     <span class='comment'># delivery timeouts
</span><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_stats'>stats</span><span class='lbracket'>[</span><span class='symbol'>:orders_dead_lettered</span><span class='rbracket'>]</span> <span class='comment'># entries added to DLQ
</span><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_stats'>stats</span><span class='lbracket'>[</span><span class='symbol'>:orders_throttled</span><span class='rbracket'>]</span>     <span class='comment'># publishes that were rate-limited
</span>
<span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_stats'>stats</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>                   <span class='comment'># snapshot of all counters
</span><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_stats'>stats</span><span class='period'>.</span><span class='id identifier rubyid_reset!'>reset!</span>                 <span class='comment'># zero all counters
</span></code></pre>

<p>When using <code>Channel</code> directly, pass a <code>Stats</code> instance:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_stats'>stats</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TypedBus/Stats.html" title="TypedBus::Stats (class)">Stats</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TypedBus/Stats.html#initialize-instance_method" title="TypedBus::Stats#initialize (method)">new</a></span></span>
<span class='id identifier rubyid_channel'>channel</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TypedBus/Channel.html" title="TypedBus::Channel (class)">Channel</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="TypedBus/Channel.html#initialize-instance_method" title="TypedBus::Channel#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='symbol'>:work</span><span class='comma'>,</span> <span class='label'>stats:</span> <span class='id identifier rubyid_stats'>stats</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='int'>5</span><span class='rparen'>)</span>
</code></pre>

<h2 id="label-Logging">Logging</h2>

<p>Assign a standard Ruby <code>Logger</code> to get structured log output from all components:</p>

<pre class="code ruby"><code class="ruby"><span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure'><span class='object_link'><a href="TypedBus.html#configure-class_method" title="TypedBus.configure (method)">configure</a></span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span> <span class='op'>=</span> <span class='const'>Logger</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='gvar'>$stdout</span><span class='rparen'>)</span>
<span class='kw'>end</span>

<span class='comment'># or use the shortcut
</span><span class='const'><span class='object_link'><a href="TypedBus.html" title="TypedBus (module)">TypedBus</a></span></span><span class='period'>.</span><span class='id identifier rubyid_logger'><span class='object_link'><a href="TypedBus.html#logger-class_method" title="TypedBus.logger (method)">logger</a></span></span> <span class='op'>=</span> <span class='const'>Logger</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='gvar'>$stdout</span><span class='rparen'>)</span>
</code></pre>

<p>Set to <code>nil</code> (the default) to disable logging.</p>

<p>Log output covers channel lifecycle, publish/subscribe events, delivery resolution, DLQ entries, backpressure waits, and throttle delays.</p>

<h2 id="label-Closing+and+Cleanup">Closing and Cleanup</h2>

<h3 id="label-Close+a+Channel">Close a Channel</h3>

<p>Stops accepting new publishes and subscribes. Pending deliveries are force-nacked and routed to the DLQ.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
<span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_closed?'>closed?</span>  <span class='comment'># =&gt; true
</span></code></pre>

<h3 id="label-Clear+a+Channel">Clear a Channel</h3>

<p>Hard reset: cancels all timeout tasks, discards pending state and DLQ contents.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_channel'>channel</span><span class='period'>.</span><span class='id identifier rubyid_clear!'>clear!</span>
</code></pre>

<h3 id="label-Bus+Shutdown">Bus Shutdown</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_close_all'>close_all</span>   <span class='comment'># close every channel
</span><span class='id identifier rubyid_bus'>bus</span><span class='period'>.</span><span class='id identifier rubyid_clear!'>clear!</span>      <span class='comment'># close, clear DLQs, and reset stats
</span></code></pre>

<h2 id="label-Architecture">Architecture</h2>

<pre class="code ruby"><code class="ruby">Publisher
    │
    ▼
Channel (type check → throttle → backpressure → fan-out)
    │
    ├──▶ Subscriber 1 ──▶ Delivery ──▶ ack!/nack!
    ├──▶ Subscriber 2 ──▶ Delivery ──▶ ack!/nack!
    └──▶ Subscriber N ──▶ Delivery ──▶ ack!/nack!
    │
    ▼
DeliveryTracker (aggregates N responses)
    │
    ├── all acked ──▶ :delivered stat
    └── any nacked ──▶ Dead Letter Queue
</code></pre>

<p><strong>Concurrency model:</strong> Fiber-only, powered by the <code>async</code> gem. No mutexes anywhere. All state is managed within a single Async reactor. <code>sleep</code> calls inside throttle and backpressure yield the fiber, not the thread.</p>

<h2 id="label-Requirements">Requirements</h2>
<ul><li>
<p>Ruby &gt;= 3.2.0</p>
</li><li>
<p><a href="https://github.com/socketry/async">async</a> ~&gt; 2.0</p>
</li></ul>

<h2 id="label-License">License</h2>

<p>MIT</p>
</div></div>

      <div id="footer">
  Generated on Sat Feb  7 05:13:55 2026 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-3.3.10).
</div>

    </div>
  </body>
</html>